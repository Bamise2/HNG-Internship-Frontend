{% extends 'layout/base.twig' %}

{% block title %}Ticket Management - TicketApp{% endblock %}

{% block content %}
<div class="tickets-page">
    <div class="container">
        <div class="tickets-header">
            <div>
                <h1>Ticket Management</h1>
                <p>Create, view, edit, and delete your tickets</p>
            </div>
            <button class="btn btn-primary" onclick="openModal()">
                ‚ûï Create Ticket
            </button>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <label for="status-filter">Filter by Status:</label>
                <select id="status-filter" class="filter-select" onchange="filterTickets(this.value)">
                    <option value="all" {{ filter == 'all' ? 'selected' : '' }}>All Tickets</option>
                    <option value="open" {{ filter == 'open' ? 'selected' : '' }}>Open</option>
                    <option value="in_progress" {{ filter == 'in_progress' ? 'selected' : '' }}>In Progress</option>
                    <option value="closed" {{ filter == 'closed' ? 'selected' : '' }}>Closed</option>
                </select>
            </div>
        </div>

        <!-- Tickets Grid -->
        {% if tickets is empty %}
            <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <h2>No tickets found</h2>
                <p>
                    {% if filter == 'all' %}
                        Get started by creating your first ticket
                    {% else %}
                        No tickets with status "{{ filter }}"
                    {% endif %}
                </p>
                {% if filter == 'all' %}
                    <button class="btn btn-primary" onclick="openModal()">
                        Create First Ticket
                    </button>
                {% endif %}
            </div>
        {% else %}
            <div class="tickets-grid">
                {% for ticket in tickets %}
                    <div class="ticket-card">
                        <div class="ticket-header">
                            <h3 class="ticket-title">{{ ticket.title }}</h3>
                            <div class="ticket-badges">
                                <span class="status-badge status-{{ ticket.status|replace({'_': '-'}) }}">
                                    {% if ticket.status == 'open' %}Open
                                    {% elseif ticket.status == 'in_progress' %}In Progress
                                    {% else %}Closed{% endif %}
                                </span>
                                {% if ticket.priority %}
                                    <span class="priority-badge priority-{{ ticket.priority }}">
                                        {{ ticket.priority }}
                                    </span>
                                {% endif %}
                            </div>
                        </div>

                        {% if ticket.description %}
                            <p class="ticket-description">{{ ticket.description }}</p>
                        {% endif %}

                        <div class="ticket-meta">
                            <span class="ticket-date">
                                üìÖ Created: {{ ticket.createdAt|date('M d, Y') }}
                            </span>
                            {% if ticket.updatedAt != ticket.createdAt %}
                                <span class="ticket-date">
                                    üîÑ Updated: {{ ticket.updatedAt|date('M d, Y') }}
                                </span>
                            {% endif %}
                        </div>

                        <div class="ticket-actions">
                            <button 
                                class="btn btn-secondary btn-sm"
                                onclick='editTicket({{ ticket|json_encode }})'
                            >
                                ‚úèÔ∏è Edit
                            </button>
                            <button 
                                class="btn btn-danger btn-sm"
                                onclick="deleteTicket({{ ticket.id }}, '{{ ticket.title|escape('js') }}')"
                            >
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal -->
<div id="ticket-modal" class="modal-overlay" style="display: none;" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modal-title">Create New Ticket</h2>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>

        <form id="ticket-form" action="/tickets/create" method="POST" class="ticket-form">
            <input type="hidden" id="ticket-id" name="id" value="">
            
            <div class="form-group">
                <label for="title">
                    Title <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="title"
                    name="title"
                    placeholder="Brief description of the issue"
                    required
                />
            </div>

            <div class="form-group">
                <label for="status">
                    Status <span class="required">*</span>
                </label>
                <select id="status" name="status" required>
                    <option value="open">Open</option>
                    <option value="in_progress">In Progress</option>
                    <option value="closed">Closed</option>
                </select>
            </div>

            <div class="form-group">
                <label for="priority">Priority</label>
                <select id="priority" name="priority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea
                    id="description"
                    name="description"
                    placeholder="Detailed description of the issue (optional)"
                    rows="4"
                ></textarea>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <span id="submit-text">Create Ticket</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Form (hidden) -->
<form id="delete-form" action="/tickets/delete" method="POST" style="display: none;">
    <input type="hidden" id="delete-id" name="id" value="">
</form>
{% endblock %}

{% block scripts %}
<script src="/js/tickets.js"></script>
{% endblock %}